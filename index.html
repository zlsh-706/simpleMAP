import React, { useState, useRef } from 'react';
import { Bus, MapPin, Navigation, Info, Settings, Plus, Trash2, X, Move, Maximize, Map, DoorOpen, Download, Upload, Save, Globe, FileCode } from 'lucide-react';

export default function App() {
  const [isEditing, setIsEditing] = useState(false);
  const [selectedStopId, setSelectedStopId] = useState(null);
  const [editingElementId, setEditingElementId] = useState(null);
  const fileInputRef = useRef(null);

  // --- 資料狀態管理 (State) ---

  // 1. 地圖物件設定
  const [mapElements, setMapElements] = useState({
    streetTop: { 
      id: 'streetTop', label: '上方街道', text: '貴陽街一段', 
      cx: 50, cy: 15, w: 100, h: 12, type: 'street-h', color: 'bg-gray-300' 
    },
    streetBottom: { 
      id: 'streetBottom', label: '下方街道', text: '愛國西路', 
      cx: 50, cy: 85, w: 100, h: 12, type: 'street-h', color: 'bg-gray-300' 
    },
    streetLeft: { 
      id: 'streetLeft', label: '左側街道', text: '重慶南路一段', 
      cx: 15, cy: 50, w: 12, h: 100, type: 'street-v', color: 'bg-gray-300' 
    },
    streetRight: { 
      id: 'streetRight', label: '右側街道', text: '公園路', 
      cx: 85, cy: 50, w: 12, h: 100, type: 'street-v', color: 'bg-gray-300' 
    },
    destination: { 
      id: 'destination', label: '主要目的地', text: '北一女中', sub: '正門',
      cx: 50, cy: 50, w: 40, h: 40, type: 'dest', color: 'bg-green-200',
      ex: 50, ey: 100
    },
    landmark: { 
      id: 'landmark', label: '右側地標', text: '市立大學\n附小', 
      cx: 94, cy: 50, w: 10, h: 30, type: 'landmark', color: 'bg-yellow-100' 
    },
  });

  // 2. 公車站牌資料
  const [stops, setStops] = useState([
    {
      id: 'chongqing',
      name: '一女中 (重慶)',
      locationDescription: '位於重慶南路一段',
      routes: '262, 262區',
      x: 10, y: 35, pathType: 'left', color: 'bg-blue-600'
    },
    {
      id: 'park',
      name: '一女中 (公園)',
      locationDescription: '位於公園路',
      routes: '5, 204, 630, 227',
      x: 90, y: 35, pathType: 'right', color: 'bg-green-600'
    },
    {
      id: 'guiyang',
      name: '一女中 (貴陽)',
      locationDescription: '位於貴陽街一段',
      routes: '38, 270, 235, 663',
      x: 35, y: 13, pathType: 'top', color: 'bg-orange-500'
    }
  ]);

  // --- 處理函式 ---
  const handleStopClick = (id) => { setSelectedStopId(id); setEditingElementId(null); };
  const handleElementClick = (key) => { if (isEditing) { setEditingElementId(key); setSelectedStopId(null); } };
  const updateStop = (id, field, value) => { setStops(stops.map(s => s.id === id ? { ...s, [field]: value } : s)); };
  const updateMapElement = (key, field, value) => { setMapElements({ ...mapElements, [key]: { ...mapElements[key], [field]: value } }); };
  
  const addMapElement = () => {
    const newId = `landmark-${Date.now()}`;
    setMapElements({ ...mapElements, [newId]: { id: newId, label: '新地標', text: '新地標', cx: 50, cy: 50, w: 15, h: 15, type: 'landmark', color: 'bg-gray-200' } });
    setEditingElementId(newId); 
  };
  const deleteMapElement = (key) => {
    if (key === 'destination') { alert("無法刪除主要目的地。"); return; }
    const newElements = { ...mapElements }; delete newElements[key]; setMapElements(newElements); setEditingElementId(null);
  };
  const addStop = () => {
    const newId = `stop-${Date.now()}`;
    setStops([...stops, { id: newId, name: '新站牌', locationDescription: '位置描述', routes: '路線...', x: 50, y: 50, pathType: 'bottom', color: 'bg-gray-600' }]);
    setSelectedStopId(newId); setEditingElementId(null);
  };
  const deleteStop = (id) => { setStops(stops.filter(s => s.id !== id)); if (selectedStopId === id) setSelectedStopId(null); };
  const getSelectedStop = () => stops.find(s => s.id === selectedStopId);

  // --- 匯出設定檔 (編輯用) ---
  const handleExportConfig = () => {
    const configData = { timestamp: new Date().toISOString(), mapElements, stops };
    const blob = new Blob([JSON.stringify(configData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `map_config_edit_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleImportConfig = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.mapElements && data.stops) {
                setMapElements(data.mapElements); setStops(data.stops); alert("設定檔匯入成功！");
            } else { alert("錯誤：格式不正確。"); }
        } catch (error) { alert("錯誤：無法解析檔案。"); }
    };
    reader.readAsText(file);
    event.target.value = '';
  };

  // --- 產生獨立 HTML (發布用) ---
  const handleGeneratePublicHTML = () => {
    // 這裡我們將目前的資料 "烘焙 (Bake)" 進 HTML 字串中
    // 為了讓匯出的檔案能獨立運作，我們需要包含簡易版的 React 元件邏輯
    
    const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${mapElements.destination.text} 交通指引地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .writing-vertical { writing-mode: vertical-rl; text-orientation: upright; }
        @keyframes pulse { 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // 1. 注入目前的設定資料
        const mapElements = ${JSON.stringify(mapElements)};
        const stops = ${JSON.stringify(stops)};

        const { useState } = React;

        // 簡易 SVG 圖示組件
        const BusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.34-.1-.66-.31-.93l-2.67-3.46c-.25-.33-.64-.53-1.06-.53H6.94c-.42 0-.81.2-1.06.53L3.21 13.07c-.21.27-.31.59-.31.93 0 .4.1.8.2 1.2.3 1.1.8 2.8.8 2.8h3"/><path d="M4 22v-4"/><path d="M20 22v-4"/><rect width="16" height="16" x="4" y="2" rx="2"/></svg>;
        const MapPinIcon = ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const NavigationIcon = ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>;
        const InfoIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;

        function MapViewer() {
            const [selectedStopId, setSelectedStopId] = useState(null);
            
            const getSelectedStop = () => stops.find(s => s.id === selectedStopId);

            const renderPath = (stop) => {
                if (!stop || !mapElements.destination) return null;
                const dest = mapElements.destination;
                
                // 簡易路徑計算邏輯 (與編輯器相同)
                const dW = dest.w; const dH = dest.h;
                const dL = dest.cx - dW/2; const dR = dest.cx + dW/2;
                const dT = dest.cy - dH/2; const dB = dest.cy + dH/2;
                const exVal = dest.ex !== undefined ? dest.ex : 50;
                const eyVal = dest.ey !== undefined ? dest.ey : 100;
                const targetX = dL + (dW * exVal / 100);
                const targetY = dT + (dH * eyVal / 100);

                const dists = { top: Math.abs(targetY-dT), bottom: Math.abs(targetY-dB), left: Math.abs(targetX-dL), right: Math.abs(targetX-dR) };
                const endSide = Object.keys(dists).reduce((a, b) => dists[a] < dists[b] ? a : b);
                
                const safeMargin = 6;
                const streetTop = dT - safeMargin; const streetBottom = dB + safeMargin;
                const streetLeft = dL - safeMargin; const streetRight = dR + safeMargin;
                const startSide = stop.pathType;
                
                let points = [{x: stop.x, y: stop.y}];

                if (startSide === endSide) {
                     if (startSide === 'left' || startSide === 'right') points.push({ x: stop.x, y: targetY }); 
                     else points.push({ x: targetX, y: stop.y });
                } else {
                    const isOpposite = (startSide === 'left' && endSide === 'right') || (startSide === 'right' && endSide === 'left') || (startSide === 'top' && endSide === 'bottom') || (startSide === 'bottom' && endSide === 'top');
                    if (isOpposite) {
                        if (startSide === 'left' || startSide === 'right') {
                            const goTop = Math.abs(stop.y - dT) < Math.abs(stop.y - dB);
                            const viaY = goTop ? streetTop : streetBottom;
                            const endStreetX = endSide === 'left' ? streetLeft : streetRight;
                            points.push({x: stop.x, y: viaY}, {x: endStreetX, y: viaY}, {x: endStreetX, y: targetY});
                        } else {
                            const goLeft = Math.abs(stop.x - dL) < Math.abs(stop.x - dR);
                            const viaX = goLeft ? streetLeft : streetRight;
                            const endStreetY = endSide === 'top' ? streetTop : streetBottom;
                            points.push({x: viaX, y: stop.y}, {x: viaX, y: endStreetY}, {x: targetX, y: endStreetY});
                        }
                    } else {
                        let cornerX = stop.x; let cornerY = stop.y;
                        if (endSide === 'top') cornerY = streetTop; if (endSide === 'bottom') cornerY = streetBottom;
                        if (endSide === 'left') cornerX = streetLeft; if (endSide === 'right') cornerX = streetRight;
                        if (startSide === 'left' || startSide === 'right') points.push({x: stop.x, y: cornerY}, {x: targetX, y: cornerY});
                        else points.push({x: cornerX, y: stop.y}, {x: cornerX, y: targetY});
                    }
                }
                points.push({x: targetX, y: targetY});
                return <path d={"M "+points.map(p=>p.x+" "+p.y).join(" L ")} stroke="#2563eb" strokeWidth="3" fill="none" markerEnd="url(#arrowhead)" strokeDasharray="6,4" className="animate-pulse" vectorEffect="non-scaling-stroke" strokeLinejoin="round" strokeLinecap="round" />;
            };

            const renderMapElement = (key, config) => {
                const baseStyle = { left: config.cx+'%', top: config.cy+'%', width: config.w+'%', height: config.h+'%' };
                let content = null;
                if (config.type === 'street-h') content = <span className="text-gray-500 font-bold tracking-widest text-lg opacity-60 pointer-events-none select-none">{config.text}</span>;
                else if (config.type === 'street-v') content = <span className="transform -rotate-90 lg:rotate-90 text-gray-500 font-bold tracking-widest text-lg whitespace-nowrap opacity-60 pointer-events-none select-none">{config.text}</span>;
                else if (config.type === 'dest') {
                    const ex = config.ex !== undefined ? config.ex : 50;
                    const ey = config.ey !== undefined ? config.ey : 100;
                    content = <div className="flex flex-col items-center justify-center pointer-events-none select-none w-full h-full relative"><div className="bg-green-700 text-white text-[10px] lg:text-xs px-2 py-1 rounded mb-1 lg:mb-2 whitespace-nowrap">目的地</div><div className="font-bold text-xl lg:text-2xl text-green-900 text-center leading-tight whitespace-pre-wrap">{config.text}</div>{config.sub && <div className="text-green-800 text-xs lg:text-sm mt-1 font-bold">{config.sub}</div>}<div className="absolute bg-yellow-400 border border-yellow-600 rounded-full px-3 py-0.5 text-[10px] font-bold shadow-sm transform -translate-x-1/2 -translate-y-1/2 whitespace-nowrap z-20" style={{ left: ex+'%', top: ey+'%' }}>入口</div></div>;
                }
                else if (config.type === 'landmark') content = <span className="text-yellow-700 font-bold writing-vertical text-center whitespace-pre-line leading-6 pointer-events-none select-none text-xs lg:text-base">{config.text}</span>;
                return <div key={key} style={baseStyle} className={"absolute transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center "+config.color+" "+(config.type==='dest'?'border-2 border-green-600 rounded-lg shadow-sm z-10':'')+" "+(config.type==='landmark'?'border-2 border-yellow-300 rounded-lg opacity-80 z-0':'')}>{content}</div>;
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4 font-sans text-gray-800">
                    <header className="w-full max-w-6xl bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center mb-4">
                        <h1 className="text-xl font-bold flex items-center gap-2 text-blue-900">
                            <MapPinIcon size={20} />
                            {mapElements.destination ? mapElements.destination.text : '交通地圖'}
                        </h1>
                    </header>
                    <div className="flex flex-col lg:flex-row w-full max-w-6xl gap-4 h-[calc(100vh-140px)] min-h-[600px]">
                        <div className="relative w-full lg:w-2/3 bg-white rounded-xl shadow-md border-4 border-gray-200 overflow-hidden select-none flex flex-col">
                            <div className="relative w-full h-full bg-gray-100 overflow-hidden" onClick={()=>setSelectedStopId(null)}>
                                {Object.keys(mapElements).map(key => renderMapElement(key, mapElements[key]))}
                                <svg className="absolute inset-0 w-full h-full pointer-events-none z-20" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <defs><marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><polygon points="0 0, 6 3, 0 6" fill="#2563eb" /></marker></defs>
                                    {renderPath(getSelectedStop())}
                                </svg>
                                {stops.map((stop) => (
                                    <button key={stop.id} onClick={(e) => { e.stopPropagation(); setSelectedStopId(stop.id); }} style={{ top: stop.y+'%', left: stop.x+'%' }} className={"absolute z-30 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 group "+(selectedStopId === stop.id ? 'scale-125 z-40' : 'hover:scale-110')}>
                                        <div className={"w-10 h-10 lg:w-12 lg:h-12 rounded-full "+stop.color+" text-white flex items-center justify-center border-2 border-white shadow-lg "+(selectedStopId === stop.id ? 'ring-4 ring-yellow-400' : '')}><BusIcon /></div>
                                        <div className={"absolute top-full left-1/2 transform -translate-x-1/2 mt-1 px-2 py-1 bg-white text-xs font-bold rounded shadow-md border border-gray-200 whitespace-nowrap "+(selectedStopId === stop.id ? 'text-blue-700 ring-2 ring-blue-300' : 'text-gray-700')}>{stop.name}</div>
                                    </button>
                                ))}
                                <div className="absolute top-4 right-4 text-gray-400 flex flex-col items-center opacity-50 pointer-events-none"><div className="text-lg font-serif font-bold">N</div><div className="w-1 h-6 bg-gray-400 rounded-full"></div></div>
                            </div>
                        </div>
                        <div className="w-full lg:w-1/3 flex flex-col h-full overflow-hidden">
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 h-full overflow-y-auto">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2"><InfoIcon className="mr-2 text-blue-600" />詳細資訊</h2>
                                {getSelectedStop() ? (
                                    <div className="animate-fade-in">
                                        <h3 className="text-2xl font-bold text-blue-800 mb-2">{getSelectedStop().name}</h3>
                                        <p className="text-gray-500 text-sm mb-4 flex items-center"><MapPinIcon size={16} className="mr-1" />{getSelectedStop().locationDescription}</p>
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4"><h4 className="font-bold text-blue-900 mb-2 flex items-center"><BusIcon size={18} className="mr-2" />停靠公車路線</h4><div className="flex flex-wrap gap-2">{getSelectedStop().routes.split(/,|，/).map((route, idx) => (<span key={idx} className="px-3 py-1 bg-white text-blue-600 font-bold rounded-full shadow-sm border border-blue-200 text-sm">{route.trim()}</span>))}</div></div>
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-100"><h4 className="font-bold text-green-900 mb-2 flex items-center"><NavigationIcon size={18} className="mr-2" />步行指引</h4><p className="text-gray-700 text-sm leading-relaxed">下車後，請依照地圖上的<span className="text-blue-600 font-bold mx-1">藍色虛線箭頭</span>方向，前往 {mapElements.destination.text}。</p></div>
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-400 text-center py-10 opacity-60"><BusIcon size={48} className="mb-4 opacity-20" /><p>請點擊左側地圖上的<br/>公車圖示以查看資訊</p></div>
                                )}
                            </div>
                        </div>
                    </div>
                     <footer className="mt-4 text-gray-400 text-xs text-center">資料來源：Google Maps 彙整 | 僅供參考</footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MapViewer />);
    </script>
</body>
</html>
    `;

    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `public_map_${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- 核心演算法：智慧路徑渲染 ---
  const renderPath = (stop) => {
    if (!stop || !mapElements.destination) return null;

    const dest = mapElements.destination;
    
    const dW = dest.w;
    const dH = dest.h;
    const dL = dest.cx - dW / 2; 
    const dR = dest.cx + dW / 2; 
    const dT = dest.cy - dH / 2; 
    const dB = dest.cy + dH / 2; 

    const exVal = dest.ex !== undefined ? dest.ex : 50;
    const eyVal = dest.ey !== undefined ? dest.ey : 100;
    const targetX = dL + (dW * exVal / 100);
    const targetY = dT + (dH * eyVal / 100);

    const dists = {
        top: Math.abs(targetY - dT),
        bottom: Math.abs(targetY - dB),
        left: Math.abs(targetX - dL),
        right: Math.abs(targetX - dR)
    };
    const endSide = Object.keys(dists).reduce((a, b) => dists[a] < dists[b] ? a : b);

    const safeMargin = 6; 
    const streetTop = dT - safeMargin;
    const streetBottom = dB + safeMargin;
    const streetLeft = dL - safeMargin;
    const streetRight = dR + safeMargin;

    const startSide = stop.pathType; 

    let points = [];
    points.push({ x: stop.x, y: stop.y }); 

    if (startSide === endSide) {
        if (startSide === 'left' || startSide === 'right') {
            points.push({ x: stop.x, y: targetY }); 
        } else {
            points.push({ x: targetX, y: stop.y }); 
        }
    } else {
        const isOpposite = (startSide === 'left' && endSide === 'right') || 
                           (startSide === 'right' && endSide === 'left') ||
                           (startSide === 'top' && endSide === 'bottom') ||
                           (startSide === 'bottom' && endSide === 'top');

        if (isOpposite) {
            if (startSide === 'left' || startSide === 'right') {
                const goTop = Math.abs(stop.y - dT) < Math.abs(stop.y - dB);
                const viaY = goTop ? streetTop : streetBottom; 
                points.push({ x: stop.x, y: viaY }); 
                const endStreetX = endSide === 'left' ? streetLeft : streetRight;
                points.push({ x: endStreetX, y: viaY }); 
                points.push({ x: endStreetX, y: targetY }); 
            } else {
                const goLeft = Math.abs(stop.x - dL) < Math.abs(stop.x - dR);
                const viaX = goLeft ? streetLeft : streetRight;
                points.push({ x: viaX, y: stop.y }); 
                const endStreetY = endSide === 'top' ? streetTop : streetBottom;
                points.push({ x: viaX, y: endStreetY }); 
                points.push({ x: targetX, y: endStreetY }); 
            }
        } else {
            let cornerX = stop.x;
            let cornerY = stop.y;

            if (endSide === 'top') cornerY = streetTop;
            if (endSide === 'bottom') cornerY = streetBottom;
            if (endSide === 'left') cornerX = streetLeft;
            if (endSide === 'right') cornerX = streetRight;

            if (startSide === 'left' || startSide === 'right') {
                points.push({ x: stop.x, y: cornerY }); 
                points.push({ x: targetX, y: cornerY });
            } else {
                points.push({ x: cornerX, y: stop.y });
                points.push({ x: cornerX, y: targetY });
            }
        }
    }

    points.push({ x: targetX, y: targetY }); 

    const d = `M ${points.map(p => `${p.x} ${p.y}`).join(' L ')}`;

    return (
        <path 
            d={d} 
            stroke="#2563eb" 
            strokeWidth="3" 
            fill="none" 
            markerEnd="url(#arrowhead)" 
            strokeDasharray="6,4" 
            className="animate-pulse"
            vectorEffect="non-scaling-stroke" 
            strokeLinejoin="round" 
            strokeLinecap="round"
        />
    );
  };

  // 通用渲染地圖物件函式
  const renderMapElement = (key, config) => {
    const isSelected = editingElementId === key;
    
    const baseStyle = {
        left: `${config.cx}%`,
        top: `${config.cy}%`,
        width: `${config.w}%`,
        height: `${config.h}%`,
    };

    let content = null;
    
    if (config.type === 'street-h') {
        content = (
             <span className="text-gray-500 font-bold tracking-widest text-lg opacity-60 pointer-events-none select-none">
                {config.text}
             </span>
        );
    } else if (config.type === 'street-v') {
        content = (
            <span className="transform -rotate-90 lg:rotate-90 text-gray-500 font-bold tracking-widest text-lg whitespace-nowrap opacity-60 pointer-events-none select-none">
                {config.text}
            </span>
        );
    } else if (config.type === 'dest') {
        const ex = config.ex !== undefined ? config.ex : 50;
        const ey = config.ey !== undefined ? config.ey : 100;

        content = (
            <div className="flex flex-col items-center justify-center pointer-events-none select-none w-full h-full relative">
                <div className="bg-green-700 text-white text-[10px] lg:text-xs px-2 py-1 rounded mb-1 lg:mb-2 whitespace-nowrap">目的地</div>
                <div className="font-bold text-xl lg:text-2xl text-green-900 text-center leading-tight whitespace-pre-wrap">{config.text}</div>
                {config.sub && <div className="text-green-800 text-xs lg:text-sm mt-1 font-bold">{config.sub}</div>}
                
                <div 
                    className="absolute bg-yellow-400 border border-yellow-600 rounded-full px-3 py-0.5 text-[10px] font-bold shadow-sm transform -translate-x-1/2 -translate-y-1/2 whitespace-nowrap z-20"
                    style={{ left: `${ex}%`, top: `${ey}%` }}
                >
                    入口
                </div>
            </div>
        );
    } else if (config.type === 'landmark') {
        content = (
             <span className="text-yellow-700 font-bold writing-vertical text-center whitespace-pre-line leading-6 pointer-events-none select-none text-xs lg:text-base">
                {config.text}
             </span>
        );
    }

    return (
        <div 
            key={key}
            onClick={(e) => { e.stopPropagation(); handleElementClick(key); }}
            style={baseStyle}
            className={`absolute transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center transition-all duration-200
                ${config.color}
                ${config.type === 'dest' ? 'border-2 border-green-600 rounded-lg shadow-sm z-10' : ''}
                ${config.type === 'landmark' ? 'border-2 border-yellow-300 rounded-lg opacity-80 z-0' : ''}
                ${isEditing && isSelected ? 'ring-4 ring-yellow-400 z-50 cursor-pointer shadow-xl' : ''}
                ${isEditing && !isSelected ? 'hover:ring-2 hover:ring-yellow-200 cursor-pointer' : ''}
            `}
        >
            {content}
            {isEditing && (
                <div className="absolute top-0 left-0 bg-yellow-400 text-[8px] text-yellow-900 px-1 rounded-br opacity-50">
                    {config.label}
                </div>
            )}
        </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 font-sans text-gray-800">
      
      {/* 頂部導航列 */}
      <nav className="w-full max-w-6xl bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center mb-4">
        <h1 className="text-xl font-bold flex items-center gap-2 text-blue-900">
          <MapPin className="w-5 h-5" />
          {mapElements.destination ? mapElements.destination.text : '交通地圖'}
        </h1>
        <button 
            onClick={() => {
                setIsEditing(!isEditing);
                setEditingElementId(null);
                setSelectedStopId(null);
            }}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors font-bold ${isEditing ? 'bg-yellow-500 text-white shadow-inner' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
        >
            {isEditing ? <><X size={18}/> 關閉編輯</> : <><Settings size={18}/> 編輯設定</>}
        </button>
      </nav>

      <div className="flex flex-col lg:flex-row w-full max-w-6xl gap-4 h-[calc(100vh-140px)] min-h-[600px]">
        
        {/* 左側：地圖區域 */}
        <div className="relative w-full lg:w-2/3 bg-white rounded-xl shadow-md border-4 border-gray-200 overflow-hidden select-none flex flex-col group">
            
            <div 
                className="relative w-full h-full bg-gray-100 overflow-hidden" 
                onClick={() => {
                    if(isEditing) { setEditingElementId(null); setSelectedStopId(null); }
                }}
            >
                {/* 提示文字 */}
                {isEditing && !editingElementId && !selectedStopId && (
                    <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                        <div className="bg-black/50 text-white px-4 py-2 rounded-full backdrop-blur-sm animate-pulse text-center">
                            點擊物件進行編輯<br/>或使用右側面板新增
                        </div>
                    </div>
                )}

                {/* 渲染所有地圖物件 */}
                {Object.keys(mapElements).map(key => renderMapElement(key, mapElements[key]))}

                {/* 路徑層 */}
                <svg className="absolute inset-0 w-full h-full pointer-events-none z-20" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <defs>
                        <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                            <polygon points="0 0, 6 3, 0 6" fill="#2563eb" />
                        </marker>
                    </defs>
                    {renderPath(getSelectedStop())}
                </svg>

                {/* 公車站牌 */}
                {stops.map((stop) => (
                    <button
                        key={stop.id}
                        onClick={(e) => { e.stopPropagation(); handleStopClick(stop.id); }}
                        style={{ top: `${stop.y}%`, left: `${stop.x}%` }}
                        className={`absolute z-30 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 group
                            ${selectedStopId === stop.id ? 'scale-125 z-40' : 'hover:scale-110'}
                            ${isEditing ? 'cursor-move' : ''}
                        `}
                    >
                        <div className={`w-10 h-10 lg:w-12 lg:h-12 rounded-full ${stop.color} text-white flex items-center justify-center border-2 border-white shadow-lg ${isEditing && selectedStopId === stop.id ? 'ring-4 ring-yellow-400' : ''}`}>
                            <Bus className="w-5 h-5 lg:w-6 lg:h-6" />
                        </div>
                        <div className={`absolute top-full left-1/2 transform -translate-x-1/2 mt-1 px-2 py-1 bg-white text-xs font-bold rounded shadow-md border border-gray-200 whitespace-nowrap
                             ${selectedStopId === stop.id ? 'text-blue-700 ring-2 ring-blue-300' : 'text-gray-700'}
                        `}>
                            {stop.name}
                        </div>
                    </button>
                ))}

                {/* 指北針 */}
                <div className="absolute top-4 right-4 text-gray-400 flex flex-col items-center opacity-50 pointer-events-none">
                    <div className="text-lg font-serif font-bold">N</div>
                    <div className="w-1 h-6 bg-gray-400 rounded-full"></div>
                </div>
            </div>
        </div>

        {/* 右側：控制面板 */}
        <div className="w-full lg:w-1/3 flex flex-col h-full overflow-hidden">
            
            {isEditing ? (
                // --- 編輯模式面板 ---
                <div className="bg-white rounded-xl shadow-md border border-yellow-400 flex flex-col h-full overflow-hidden">
                    <div className="p-4 bg-yellow-50 border-b border-yellow-200 flex justify-between items-center">
                        <h2 className="font-bold text-yellow-800 flex items-center gap-2">
                            <Settings size={20} />
                            {editingElementId ? `編輯物件` : (selectedStopId ? '編輯站牌' : '地圖編輯器')}
                        </h2>
                        <span className="text-xs text-yellow-600 bg-yellow-200 px-2 py-1 rounded-full">編輯中</span>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        
                        {/* 1. 地圖物件編輯器 */}
                        {editingElementId && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="flex justify-between items-start">
                                    <div className="w-full mr-2">
                                        <label className="text-xs text-gray-500 block mb-1">顯示文字</label>
                                        <textarea 
                                            rows={mapElements[editingElementId].type.includes('street') ? 1 : 2}
                                            value={mapElements[editingElementId].text} 
                                            onChange={(e) => updateMapElement(editingElementId, 'text', e.target.value)} 
                                            className="w-full text-sm border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                                        />
                                    </div>
                                    {/* 刪除按鈕 */}
                                    {mapElements[editingElementId].type !== 'dest' && (
                                        <button onClick={() => deleteMapElement(editingElementId)} className="mt-6 text-red-400 hover:text-red-600 bg-red-50 p-2 rounded shrink-0">
                                            <Trash2 size={16} />
                                        </button>
                                    )}
                                </div>

                                {mapElements[editingElementId].type === 'dest' && (
                                    <input
                                        type="text"
                                        placeholder="副標題 (例如: 正門)"
                                        value={mapElements[editingElementId].sub || ''} 
                                        onChange={(e) => updateMapElement(editingElementId, 'sub', e.target.value)} 
                                        className="w-full text-sm border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                                    />
                                )}

                                <div className="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-4">
                                    <div className="flex items-center gap-2 text-gray-700 font-bold text-sm">
                                        <Move size={16} /> 位置與尺寸
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] text-gray-500 block">左右 (X%)</label>
                                            <input 
                                                type="range" min="0" max="100" value={mapElements[editingElementId].cx} 
                                                onChange={(e) => updateMapElement(editingElementId, 'cx', parseInt(e.target.value))}
                                                className="w-full h-1 bg-blue-300 rounded-lg appearance-none cursor-pointer"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-gray-500 block">上下 (Y%)</label>
                                            <input 
                                                type="range" min="0" max="100" value={mapElements[editingElementId].cy} 
                                                onChange={(e) => updateMapElement(editingElementId, 'cy', parseInt(e.target.value))}
                                                className="w-full h-1 bg-blue-300 rounded-lg appearance-none cursor-pointer"
                                            />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] text-gray-500 block flex items-center gap-1"><Maximize size={10}/> 寬度 (W%)</label>
                                            <input 
                                                type="range" min="1" max="100" value={mapElements[editingElementId].w} 
                                                onChange={(e) => updateMapElement(editingElementId, 'w', parseInt(e.target.value))}
                                                className="w-full h-1 bg-green-300 rounded-lg appearance-none cursor-pointer"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-gray-500 block flex items-center gap-1"><Maximize size={10} className="rotate-90"/> 高度 (H%)</label>
                                            <input 
                                                type="range" min="1" max="100" value={mapElements[editingElementId].h} 
                                                onChange={(e) => updateMapElement(editingElementId, 'h', parseInt(e.target.value))}
                                                className="w-full h-1 bg-green-300 rounded-lg appearance-none cursor-pointer"
                                            />
                                        </div>
                                    </div>
                                </div>
                                
                                {/* 目的地入口位置調整 */}
                                {mapElements[editingElementId].type === 'dest' && (
                                     <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200 space-y-3">
                                        <div className="flex items-center gap-2 text-yellow-800 font-bold text-sm">
                                            <DoorOpen size={16} /> 入口標記位置
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] text-gray-500 block">入口左右 (Ex%)</label>
                                                <input 
                                                    type="range" min="0" max="100" 
                                                    value={mapElements[editingElementId].ex !== undefined ? mapElements[editingElementId].ex : 50} 
                                                    onChange={(e) => updateMapElement(editingElementId, 'ex', parseInt(e.target.value))}
                                                    className="w-full h-1 bg-yellow-400 rounded-lg appearance-none cursor-pointer"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-gray-500 block">入口上下 (Ey%)</label>
                                                <input 
                                                    type="range" min="0" max="120" 
                                                    value={mapElements[editingElementId].ey !== undefined ? mapElements[editingElementId].ey : 100} 
                                                    onChange={(e) => updateMapElement(editingElementId, 'ey', parseInt(e.target.value))}
                                                    className="w-full h-1 bg-yellow-400 rounded-lg appearance-none cursor-pointer"
                                                />
                                            </div>
                                        </div>
                                        <p className="text-[10px] text-gray-500 text-center">調整相對於目的地建築的入口標籤位置</p>
                                     </div>
                                )}

                                {/* 類型/顏色選擇 */}
                                {mapElements[editingElementId].type === 'landmark' && (
                                     <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-[10px] text-gray-500 block mb-1">顏色</label>
                                            <select 
                                                value={mapElements[editingElementId].color}
                                                onChange={(e) => updateMapElement(editingElementId, 'color', e.target.value)}
                                                className="w-full text-xs border p-1 rounded"
                                            >
                                                <option value="bg-gray-200">灰色</option>
                                                <option value="bg-yellow-100">黃色</option>
                                                <option value="bg-blue-100">藍色</option>
                                                <option value="bg-red-100">紅色</option>
                                                <option value="bg-green-100">綠色</option>
                                            </select>
                                        </div>
                                     </div>
                                )}
                                
                                <button onClick={() => setEditingElementId(null)} className="w-full py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm font-bold text-gray-600">
                                    完成修改
                                </button>
                            </div>
                        )}

                        {/* 2. 站牌編輯器 */}
                        {selectedStopId && !editingElementId && (() => {
                            const stop = getSelectedStop();
                            if (!stop) return null;
                            return (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1 mr-2">
                                            <label className="text-xs text-gray-500 block mb-1">站牌名稱</label>
                                            <input 
                                                type="text" 
                                                value={stop.name} 
                                                onChange={(e) => updateStop(stop.id, 'name', e.target.value)}
                                                className="w-full font-bold text-gray-800 border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                            />
                                        </div>
                                        <button onClick={() => deleteStop(stop.id)} className="mt-6 text-red-400 hover:text-red-600 bg-red-50 p-2 rounded">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>

                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-3">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] text-gray-500 block">左右 (X%)</label>
                                                <input 
                                                    type="range" min="0" max="100" value={stop.x} 
                                                    onChange={(e) => updateStop(stop.id, 'x', parseInt(e.target.value))}
                                                    className="w-full h-1 bg-blue-400 rounded-lg appearance-none cursor-pointer"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-gray-500 block">上下 (Y%)</label>
                                                <input 
                                                    type="range" min="0" max="100" value={stop.y} 
                                                    onChange={(e) => updateStop(stop.id, 'y', parseInt(e.target.value))}
                                                    className="w-full h-1 bg-blue-400 rounded-lg appearance-none cursor-pointer"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">路線</label>
                                        <input type="text" value={stop.routes} onChange={(e) => updateStop(stop.id, 'routes', e.target.value)} className="w-full text-sm border p-2 rounded" />
                                    </div>
                                    
                                     <div>
                                        <label className="text-xs text-gray-500 block mb-1">指引路徑方向</label>
                                        <select 
                                            value={stop.pathType} 
                                            onChange={(e) => updateStop(stop.id, 'pathType', e.target.value)}
                                            className="w-full text-sm border p-2 rounded bg-white"
                                        >
                                            <option value="left">從左方進入</option>
                                            <option value="right">從右方進入</option>
                                            <option value="top">從上方進入</option>
                                            <option value="bottom">從下方進入</option>
                                        </select>
                                        <p className="text-[10px] text-gray-400 mt-1">決定起點所在的街道方向</p>
                                    </div>

                                    <button onClick={() => setSelectedStopId(null)} className="w-full py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm font-bold text-gray-600">
                                        完成修改
                                    </button>
                                </div>
                            );
                        })()}

                        {/* 3. 資料存取與發布 */}
                        {!editingElementId && !selectedStopId && (
                            <div className="space-y-6">
                                <section>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">地圖物件</h3>
                                        <button onClick={addMapElement} className="text-xs flex items-center gap-1 bg-yellow-100 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-200 transition">
                                            <Plus size={14} /> 新增地標
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.keys(mapElements).map(key => (
                                            <button 
                                                key={key}
                                                onClick={() => setEditingElementId(key)}
                                                className="text-left px-3 py-2 bg-gray-50 border border-gray-200 rounded hover:bg-yellow-50 hover:border-yellow-300 hover:text-yellow-800 transition text-sm truncate"
                                            >
                                                {mapElements[key].label}
                                            </button>
                                        ))}
                                    </div>
                                </section>

                                <hr className="border-gray-100" />

                                <section>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">公車站牌</h3>
                                        <button onClick={addStop} className="text-xs flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">
                                            <Plus size={14} /> 新增站牌
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                         {stops.map(stop => (
                                            <button 
                                                key={stop.id}
                                                onClick={() => setSelectedStopId(stop.id)}
                                                className="w-full text-left px-3 py-2 bg-white border border-gray-200 rounded hover:border-blue-300 hover:text-blue-700 transition text-sm flex items-center gap-2"
                                            >
                                                <div className={`w-2 h-2 rounded-full ${stop.color}`}></div>
                                                {stop.name}
                                            </button>
                                        ))}
                                    </div>
                                </section>

                                <hr className="border-gray-100" />

                                {/* 4. 資料存取區塊 */}
                                <section>
                                     <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                        <Save size={14}/> 存取與發布
                                     </h3>
                                     
                                     {/* 發布按鈕 (最重要) */}
                                     <button 
                                        onClick={handleGeneratePublicHTML}
                                        className="w-full flex items-center justify-center p-3 mb-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition"
                                     >
                                        <Globe size={20} className="mr-2"/>
                                        <div className="text-left">
                                            <div className="text-sm font-bold">匯出發布網頁 (HTML)</div>
                                            <div className="text-[10px] text-blue-200">下載一個包含目前地圖的獨立網頁</div>
                                        </div>
                                     </button>

                                     {/* 編輯用按鈕 (次要) */}
                                     <div className="grid grid-cols-2 gap-3">
                                        <button 
                                            onClick={handleExportConfig}
                                            className="flex flex-col items-center justify-center p-2 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 transition"
                                        >
                                            <Download size={16} className="mb-1 text-gray-600"/>
                                            <span className="text-[10px] font-bold text-gray-700">備份設定檔 (.json)</span>
                                        </button>
                                        
                                        <button 
                                            onClick={() => fileInputRef.current.click()}
                                            className="flex flex-col items-center justify-center p-2 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 transition"
                                        >
                                            <Upload size={16} className="mb-1 text-gray-600"/>
                                            <span className="text-[10px] font-bold text-gray-700">還原設定檔 (.json)</span>
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleImportConfig} accept=".json" className="hidden" />
                                     </div>
                                </section>
                            </div>
                        )}

                    </div>
                </div>
            ) : (
                // --- 檢視模式面板 ---
                <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200 h-full overflow-y-auto">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                        <Info className="mr-2 text-blue-600" />
                        詳細資訊
                    </h2>
                    
                    {getSelectedStop() ? (
                        <div className="animate-fade-in">
                            <h3 className="text-2xl font-bold text-blue-800 mb-2">{getSelectedStop().name}</h3>
                            <p className="text-gray-500 text-sm mb-4 flex items-center">
                                <MapPin size={16} className="mr-1" />
                                {getSelectedStop().locationDescription}
                            </p>
                            
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                                <h4 className="font-bold text-blue-900 mb-2 flex items-center">
                                    <Bus size={18} className="mr-2" />
                                    停靠公車路線
                                </h4>
                                <div className="flex flex-wrap gap-2">
                                    {getSelectedStop().routes.split(/,|，/).map((route, idx) => (
                                        <span key={idx} className="px-3 py-1 bg-white text-blue-600 font-bold rounded-full shadow-sm border border-blue-200 text-sm">
                                            {route.trim()}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                                 <h4 className="font-bold text-green-900 mb-2 flex items-center">
                                    <Navigation size={18} className="mr-2" />
                                    步行指引
                                </h4>
                                <p className="text-gray-700 text-sm leading-relaxed">
                                    下車後，請依照地圖上的<span className="text-blue-600 font-bold mx-1">藍色虛線箭頭</span>方向，前往 {mapElements.destination ? mapElements.destination.text : '目的地'}。
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="h-full flex flex-col items-center justify-center text-gray-400 text-center py-10 opacity-60">
                            <Bus size={48} className="mb-4 opacity-20" />
                            <p>請點擊左側地圖上的<br/>公車圖示以查看資訊</p>
                            <p className="text-xs mt-4 text-gray-300">或點擊右上角「編輯設定」完全自訂地圖</p>
                        </div>
                    )}
                </div>
            )}

        </div>
      </div>
      
      <footer className="mt-4 text-gray-400 text-xs text-center">
         僅供參考示意圖 | 可自由編輯調整內容
      </footer>
    </div>
  );
}
